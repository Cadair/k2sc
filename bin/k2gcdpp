#!/usr/bin/env python
"""Gathers the auxiliary information from a set of MAST fits files into a Pandas table.
"""
from __future__ import division
import sys
import numpy as np
import pyfits as pf
import pandas as pd

from os.path import join, abspath, basename, exists
from argparse import ArgumentParser
from glob import glob

from numpy import arange, zeros, transpose

if __name__ == '__main__':
    ap = ArgumentParser()
    ap.add_argument('hdfname', help='HDF file to save the gathered cdpp data')
    ap.add_argument('datadir', help='Directory containing the reduced data')
    args = ap.parse_args()

    files = sorted(glob(join(args.datadir,'EPIC_*.fits')))
    epics = np.array(map(lambda fn:int(basename(fn).split('_')[1]), files), dtype=np.uint32)

    cdppr, cdppt, cdppc = [], [], []
    nfiles = len(files)
    for ifile, fn in enumerate(files):
        with pf.open(fn) as hdul:
            cdppr.append(hdul[1].header['cdpp1r'])
            cdppt.append(hdul[1].header['cdpp1t'])
            cdppc.append(hdul[1].header['cdpp1c'])
        print '{:d}/{:d}'.format(ifile,nfiles)

    df_cdpp = pd.DataFrame(transpose([cdppr,cdppt,cdppc]),
                          columns='cdppr cdppt cdppc'.split(),
                          index=epics, dtype=np.float32)
    df_cdpp.to_hdf(args.hdfname, 'cdpp')
